{"version":3,"file":"pushKey.js","names":["_appleUtils","data","require","_chalk","_interopRequireDefault","_dateformat","_CommandError","_log","_ora","_authenticate","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","isPushKey","apnsKeyP8","apnsKeyId","teamId","MaxKeysCreatedError","Keys","APPLE_KEYS_TOO_MANY_GENERATED_ERROR","chalk","underline","listPushKeysAsync","authCtx","spinner","ora","start","context","getRequestContext","keys","getKeysAsync","succeed","error","fail","createPushKeyAsync","name","dateformat","createKeyAsync","isApns","downloadKeyAsync","id","team","teamName","err","_err$rawDump","resultString","rawDump","match","CommandError","revokePushKeyAsync","ids","length","Promise","all","map","revokeKeyAsync","Log","PushKeyManager","constructor","appleCtx","ctx","list","create","revoke","format","exports"],"sources":["../../src/appleApi/pushKey.ts"],"sourcesContent":["import { Keys } from '@expo/apple-utils';\nimport chalk from 'chalk';\nimport dateformat from 'dateformat';\n\nimport CommandError from '../CommandError';\nimport Log from '../log';\nimport { ora } from '../utils/ora';\nimport { AppleCtx, getRequestContext } from './authenticate';\n\nexport type PushKeyInfo = {\n  id: string;\n  name: string;\n};\n\nexport type PushKey = {\n  apnsKeyP8: string;\n  apnsKeyId: string;\n  teamId: string;\n  teamName?: string;\n};\n\nexport function isPushKey(obj: { [key: string]: any }): obj is PushKey {\n  return (\n    obj.apnsKeyP8 &&\n    typeof obj.apnsKeyP8 === 'string' &&\n    obj.apnsKeyId &&\n    typeof obj.apnsKeyId === 'string' &&\n    obj.teamId &&\n    typeof obj.teamId === 'string'\n  );\n}\n\nconst { MaxKeysCreatedError } = Keys;\n\nconst APPLE_KEYS_TOO_MANY_GENERATED_ERROR = `\nYou can have only ${chalk.underline('two')} Apple Keys generated on your Apple Developer account.\nPlease revoke the old ones or reuse existing from your other apps.\nPlease remember that Apple Keys are not application specific!\n`;\n\nasync function listPushKeysAsync(authCtx: AppleCtx): Promise<PushKeyInfo[]> {\n  const spinner = ora(`Fetching Apple push keys`).start();\n  try {\n    const context = getRequestContext(authCtx);\n    const keys = await Keys.getKeysAsync(context);\n    spinner.succeed(`Fetched Apple push keys`);\n    return keys;\n  } catch (error: any) {\n    spinner.fail(`Failed to fetch Apple push keys`);\n    throw error;\n  }\n}\n\nasync function createPushKeyAsync(\n  authCtx: AppleCtx,\n  name: string = `Expo Push Notifications Key ${dateformat('yyyymmddHHMMss')}`\n): Promise<PushKey> {\n  const spinner = ora(`Creating Apple push key`).start();\n  try {\n    const context = getRequestContext(authCtx);\n    const key = await Keys.createKeyAsync(context, { name, isApns: true });\n    const apnsKeyP8 = await Keys.downloadKeyAsync(context, { id: key.id });\n    spinner.succeed(`Created Apple push key`);\n    return {\n      apnsKeyId: key.id,\n      apnsKeyP8,\n      teamId: authCtx.team.id,\n      teamName: authCtx.team.name,\n    };\n  } catch (err: any) {\n    spinner.fail('Failed to create Apple push key');\n    const resultString = err.rawDump?.resultString;\n    if (\n      err instanceof MaxKeysCreatedError ||\n      (resultString && resultString.match(/maximum allowed number of Keys/))\n    ) {\n      throw new CommandError(APPLE_KEYS_TOO_MANY_GENERATED_ERROR);\n    }\n    throw err;\n  }\n}\n\nasync function revokePushKeyAsync(authCtx: AppleCtx, ids: string[]): Promise<void> {\n  const name = `Apple push key${ids?.length === 1 ? '' : 's'}`;\n\n  const spinner = ora(`Revoking ${name}`).start();\n  try {\n    const context = getRequestContext(authCtx);\n    await Promise.all(ids.map(id => Keys.revokeKeyAsync(context, { id })));\n\n    spinner.succeed(`Revoked ${name}`);\n  } catch (error: any) {\n    Log.error(error);\n    spinner.fail(`Failed to revoke ${name}`);\n    throw error;\n  }\n}\n\nexport class PushKeyManager {\n  ctx: AppleCtx;\n  constructor(appleCtx: AppleCtx) {\n    this.ctx = appleCtx;\n  }\n\n  async list(): Promise<PushKeyInfo[]> {\n    return listPushKeysAsync(this.ctx);\n  }\n\n  async create(name?: string): Promise<PushKey> {\n    return createPushKeyAsync(this.ctx, name);\n  }\n\n  async revoke(ids: string[]) {\n    return revokePushKeyAsync(this.ctx, ids);\n  }\n\n  format({ id, name }: PushKeyInfo): string {\n    return `${name} - ID: ${id}`;\n  }\n}\n"],"mappings":"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"}