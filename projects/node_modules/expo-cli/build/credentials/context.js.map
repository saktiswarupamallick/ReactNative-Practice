{"version":3,"file":"context.js","names":["_config","data","require","_xdl","_appleApi","_log","_interopRequireDefault","_AndroidApi","_IosApi","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","Context","constructor","nonInteractive","_nonInteractive","user","_user","hasProjectContext","_hasProjectContext","projectDir","_projectDir","projectOwner","UserManager","getProjectOwner","manifest","_manifest","Error","api","_apiClient","android","_androidApiClient","ios","_iosApiClient","appleCtx","_appleCtx","hasAppleCtx","ensureAppleCtx","authenticateAsync","_appleCtxOptions","logOwnerAndProject","isProxyUser","owner","username","Log","log","slug","init","options","allowAnonymous","appleId","appleIdPassword","teamId","getCurrentUserAsync","ensureLoggedInAsync","ApiV2","clientForUser","IosApi","AndroidApi","exp","getConfig","skipSDKVersionRequirement","exports"],"sources":["../../src/credentials/context.ts"],"sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport { ApiV2, RobotUser, User, UserManager } from 'xdl';\n\nimport { AppleCtx, authenticateAsync } from '../appleApi';\nimport Log from '../log';\nimport AndroidApi from './api/AndroidApi';\nimport IosApi from './api/IosApi';\n\nexport interface IView {\n  open(ctx: Context): Promise<IView | null>;\n}\n\ninterface AppleCtxOptions {\n  appleId?: string;\n  appleIdPassword?: string;\n  teamId?: string;\n}\n\ninterface CtxOptions extends AppleCtxOptions {\n  allowAnonymous?: boolean;\n  nonInteractive?: boolean;\n}\n\nexport class Context {\n  _hasProjectContext: boolean = false;\n  _projectDir?: string;\n  _user?: User | RobotUser;\n  _manifest?: ExpoConfig;\n  _apiClient?: ApiV2;\n  _iosApiClient?: IosApi;\n  _androidApiClient?: AndroidApi;\n  _appleCtxOptions?: AppleCtxOptions;\n  _appleCtx?: AppleCtx;\n  _nonInteractive?: boolean;\n\n  get nonInteractive(): boolean {\n    return this._nonInteractive === true;\n  }\n\n  get user(): User | RobotUser {\n    return this._user as User | RobotUser;\n  }\n  get hasProjectContext(): boolean {\n    return this._hasProjectContext;\n  }\n  get projectDir(): string {\n    return this._projectDir as string;\n  }\n  get projectOwner(): string {\n    return UserManager.getProjectOwner(this.user, this.manifest);\n  }\n  get manifest(): ExpoConfig {\n    if (!this._manifest) {\n      throw new Error('Manifest (app.json) not initialized.');\n    }\n    return this._manifest;\n  }\n  get api(): ApiV2 {\n    return this._apiClient as ApiV2;\n  }\n  get android(): AndroidApi {\n    return this._androidApiClient as AndroidApi;\n  }\n  get ios(): IosApi {\n    return this._iosApiClient as IosApi;\n  }\n  get appleCtx(): AppleCtx {\n    if (!this._appleCtx) {\n      throw new Error('Apple context not initialized.');\n    }\n    return this._appleCtx;\n  }\n  set manifest(value: ExpoConfig) {\n    this._manifest = value;\n  }\n\n  hasAppleCtx(): boolean {\n    return !!this._appleCtx;\n  }\n\n  async ensureAppleCtx() {\n    if (!this._appleCtx) {\n      this._appleCtx = await authenticateAsync(this._appleCtxOptions);\n    }\n  }\n\n  logOwnerAndProject() {\n    // Figure out if User A is configuring credentials as admin for User B's project\n    const isProxyUser = this.manifest.owner && this.manifest.owner !== this.user.username;\n    Log.log(\n      `Accessing credentials ${isProxyUser ? 'on behalf of' : 'for'} ${\n        this.projectOwner\n      } in project ${this.manifest.slug}`\n    );\n  }\n\n  async init(projectDir: string, options: CtxOptions = {}) {\n    const { allowAnonymous, appleId, appleIdPassword, teamId, nonInteractive } = options;\n    this._user = (await UserManager.getCurrentUserAsync()) || undefined;\n\n    // User isn't signed it, but needs to be signed in\n    if (!this._user && !allowAnonymous) {\n      this._user = (await UserManager.ensureLoggedInAsync()) as User;\n    }\n\n    this._projectDir = projectDir;\n    this._apiClient = ApiV2.clientForUser(this.user);\n    this._iosApiClient = new IosApi(this.api);\n    this._androidApiClient = new AndroidApi(this.api);\n    this._appleCtxOptions = { appleId, appleIdPassword, teamId };\n    this._nonInteractive = nonInteractive;\n\n    // try to access project context\n    try {\n      const { exp } = getConfig(projectDir, { skipSDKVersionRequirement: true });\n      this._manifest = exp;\n      this._hasProjectContext = true;\n      this.logOwnerAndProject();\n    } catch {\n      // ignore error\n      // startcredentials manager without project context\n    }\n  }\n}\n"],"mappings":"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"}