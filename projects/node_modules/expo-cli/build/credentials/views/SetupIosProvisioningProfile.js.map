{"version":3,"file":"SetupIosProvisioningProfile.js","names":["_chalk","data","_interopRequireDefault","require","_log","iosProfileView","_interopRequireWildcard","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","SetupIosProvisioningProfile","constructor","app","open","ctx","user","Error","distCert","ios","getDistCert","appCredentials","getAppCredentials","configuredProfile","getProvisioningProfile","configuredWithSameDistCert","distCredentialsId","id","CreateOrReuseProvisioningProfile","hasAppleCtx","isValid","validateProfileWithoutApple","bundleIdentifier","provisioningProfileId","Log","log","chalk","yellow","profileFromApple","getAppleInfo","appleCtx","configureAndUpdateProvisioningProfile","exports"],"sources":["../../../src/credentials/views/SetupIosProvisioningProfile.ts"],"sourcesContent":["import chalk from 'chalk';\n\nimport Log from '../../log';\nimport { AppLookupParams } from '../api/IosApi';\nimport { Context, IView } from '../context';\nimport * as iosProfileView from './IosProvisioningProfile';\n\nexport class SetupIosProvisioningProfile implements IView {\n  constructor(private app: AppLookupParams) {}\n\n  async open(ctx: Context): Promise<IView | null> {\n    if (!ctx.user) {\n      throw new Error(`This workflow requires you to be logged in.`);\n    }\n\n    const distCert = await ctx.ios.getDistCert(this.app);\n    if (!distCert) {\n      // dist cert should already be created\n      // TODO: trigger dist cert creation here\n      throw new Error('There is no distribution certificate assigned for this app');\n    }\n\n    const appCredentials = await ctx.ios.getAppCredentials(this.app);\n\n    // Try to use the profile we have on file first\n    const configuredProfile = await ctx.ios.getProvisioningProfile(this.app);\n\n    // We dont have a profile on expo servers or\n    // The configured profile is associated with some other dist cert\n    const configuredWithSameDistCert = appCredentials.distCredentialsId === distCert.id;\n    if (!configuredProfile || !configuredWithSameDistCert) {\n      return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n    }\n\n    if (!ctx.hasAppleCtx()) {\n      const isValid = await iosProfileView.validateProfileWithoutApple(\n        configuredProfile,\n        distCert,\n        this.app.bundleIdentifier\n      );\n      if (!isValid) {\n        throw new Error(`The provisioning profile we have on file is no longer valid.`);\n      }\n      return null;\n    }\n\n    // User uploaded profiles dont have ids - do best effort validation here\n    if (!configuredProfile.provisioningProfileId) {\n      Log.log(\n        chalk.yellow(\n          \"The provisioning profile we have on file cannot be validated on Apple's servers.\"\n        )\n      );\n      const isValid = await iosProfileView.validateProfileWithoutApple(\n        configuredProfile,\n        distCert,\n        this.app.bundleIdentifier\n      );\n      if (!isValid) {\n        return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n      }\n      return null;\n    }\n\n    const profileFromApple = await iosProfileView.getAppleInfo(\n      ctx.appleCtx,\n      this.app.bundleIdentifier,\n      configuredProfile\n    );\n\n    // Profile can't be found on Apple servers\n    if (!profileFromApple) {\n      return new iosProfileView.CreateOrReuseProvisioningProfile(this.app);\n    }\n\n    await iosProfileView.configureAndUpdateProvisioningProfile(\n      ctx,\n      this.app,\n      distCert,\n      profileFromApple\n    );\n    return null;\n  }\n}\n"],"mappings":"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"}