{"version":3,"file":"installAsync.js","names":["_config","data","require","PackageManager","_interopRequireWildcard","_chalk","_interopRequireDefault","_npmPackageArg","_resolveFrom","_xdl","_CommandError","_log","_getRemoteVersionsForSdk","_migration","_ProjectUtils","_autoAddConfigPluginsAsync","_bundledNativeModules","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","resolveExpoProjectRootAsync","info","findProjectRootAsync","process","cwd","projectRoot","error","code","Log","addNewLineIfNone","message","newLine","log","chalk","cyan","bold","SilentError","actionAsync","packages","options","_pkg$dependencies","warnAboutLocalCLI","localCmd","packageManager","createForProject","npm","yarn","exp","pkg","getConfig","skipSDKVersionRequirement","skipPlugins","dependencies","addAsync","sdkVersion","CommandError","name","toLowerCase","Versions","gteSdkVersion","resolveFrom","silent","installAsync","bundledNativeModules","getBundledNativeModulesAsync","versionsForSdk","getRemoteVersionsForSdk","nativeModulesCount","othersCount","unparsedParameterFound","parameters","forEach","packageName","startsWith","push","versionedPackages","filter","arg","includes","map","type","raw","npmPackageArg","messages","Boolean","join","addWithParametersAsync","autoAddConfigPluginsAsync","split","isPluginError","warn"],"sources":["../../src/commands/installAsync.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\nimport npmPackageArg from 'npm-package-arg';\nimport resolveFrom from 'resolve-from';\nimport { Versions } from 'xdl';\n\nimport CommandError, { SilentError } from '../CommandError';\nimport Log from '../log';\nimport { getRemoteVersionsForSdk } from '../utils/getRemoteVersionsForSdk';\nimport { warnAboutLocalCLI } from '../utils/migration';\nimport { findProjectRootAsync } from './utils/ProjectUtils';\nimport { autoAddConfigPluginsAsync } from './utils/autoAddConfigPluginsAsync';\nimport { getBundledNativeModulesAsync } from './utils/bundledNativeModules';\n\nasync function resolveExpoProjectRootAsync() {\n  try {\n    const info = await findProjectRootAsync(process.cwd());\n    return info.projectRoot;\n  } catch (error: any) {\n    if (error.code !== 'NO_PROJECT') {\n      // An unknown error occurred.\n      throw error;\n    }\n    // This happens when an app.config exists but a package.json is not present.\n    Log.addNewLineIfNone();\n    Log.error(error.message);\n    Log.newLine();\n    Log.log(chalk.cyan(`You can create a new project with ${chalk.bold(`expo init`)}`));\n    Log.newLine();\n    throw new SilentError(error);\n  }\n}\n\nexport async function actionAsync(\n  packages: string[],\n  options: PackageManager.CreateForProjectOptions\n) {\n  const projectRoot = await resolveExpoProjectRootAsync();\n  warnAboutLocalCLI(projectRoot, { localCmd: 'install' });\n\n  const packageManager = PackageManager.createForProject(projectRoot, {\n    npm: options.npm,\n    yarn: options.yarn,\n    log: Log.log,\n  });\n\n  let { exp, pkg } = getConfig(projectRoot, {\n    skipSDKVersionRequirement: true,\n    // Sometimes users will add a plugin to the config before installing the library,\n    // this wouldn't work unless we dangerously disable plugin serialization.\n    skipPlugins: true,\n  });\n\n  // If using `expo install` in a project without the expo package even listed\n  // in package.json, just fall through to npm/yarn.\n  //\n  if (!pkg.dependencies?.['expo']) {\n    return await packageManager.addAsync(...packages);\n  }\n\n  if (!exp.sdkVersion) {\n    Log.addNewLineIfNone();\n    throw new CommandError(\n      `The ${chalk.bold(`expo`)} package was found in your ${chalk.bold(\n        `package.json`\n      )} but we couldn't resolve the Expo SDK version. Run ${chalk.bold(\n        `${packageManager.name.toLowerCase()} install`\n      )} and then try this command again.\\n`\n    );\n  }\n\n  if (!Versions.gteSdkVersion(exp, '33.0.0')) {\n    const message = `${chalk.bold(\n      `expo install`\n    )} is only available for Expo SDK version 33 or higher.`;\n    Log.addNewLineIfNone();\n    Log.error(message);\n    Log.newLine();\n    Log.log(chalk.cyan(`Current version: ${chalk.bold(exp.sdkVersion)}`));\n    Log.newLine();\n    throw new SilentError(message);\n  }\n\n  // This shouldn't be invoked because `findProjectRootAsync` will throw if node_modules are missing.\n  // Every React project should have react installed...\n  if (!resolveFrom.silent(projectRoot, 'react')) {\n    Log.addNewLineIfNone();\n    Log.log(chalk.cyan(`node_modules not found, running ${packageManager.name} install command.`));\n    Log.newLine();\n    await packageManager.installAsync();\n  }\n\n  const bundledNativeModules = await getBundledNativeModulesAsync(projectRoot, exp.sdkVersion);\n  const versionsForSdk = await getRemoteVersionsForSdk(exp.sdkVersion);\n\n  let nativeModulesCount = 0;\n  let othersCount = 0;\n  let unparsedParameterFound = false;\n  const parameters: string[] = [];\n\n  // Detect unparsed parameters that are passed in\n  // Assume anything after the first one to be a parameter (to support cases like `-- --loglevel verbose`)\n  packages.forEach(packageName => {\n    if (packageName.startsWith('-')) {\n      unparsedParameterFound = true;\n    }\n\n    if (unparsedParameterFound) {\n      parameters.push(packageName);\n    }\n  });\n\n  const versionedPackages = packages\n    .filter(arg => !parameters.includes(arg))\n    .map(arg => {\n      const { name, type, raw } = npmPackageArg(arg);\n\n      if (['tag', 'version', 'range'].includes(type) && name && bundledNativeModules[name]) {\n        // Unimodule packages from npm registry are modified to use the bundled version.\n        nativeModulesCount++;\n        return `${name}@${bundledNativeModules[name]}`;\n      } else if (name && versionsForSdk[name]) {\n        // Some packages have the recommended version listed in https://exp.host/--/api/v2/versions.\n        othersCount++;\n        return `${name}@${versionsForSdk[name]}`;\n      } else {\n        // Other packages are passed through unmodified.\n        othersCount++;\n        return raw;\n      }\n    });\n\n  const messages = [\n    nativeModulesCount > 0 &&\n      `${nativeModulesCount} SDK ${exp.sdkVersion} compatible native ${\n        nativeModulesCount === 1 ? 'module' : 'modules'\n      }`,\n    othersCount > 0 && `${othersCount} other ${othersCount === 1 ? 'package' : 'packages'}`,\n  ].filter(Boolean);\n  Log.log(`Installing ${messages.join(' and ')} using ${packageManager.name}.`);\n\n  await packageManager.addWithParametersAsync(versionedPackages, parameters);\n\n  try {\n    exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp;\n\n    // Only auto add plugins if the plugins array is defined or if the project is using SDK +42.\n    await autoAddConfigPluginsAsync(\n      projectRoot,\n      exp,\n      versionedPackages.map(pkg => pkg.split('@')[0]).filter(Boolean)\n    );\n  } catch (error: any) {\n    if (error.isPluginError) {\n      Log.warn(`Skipping config plugin check: ` + error.message);\n      return;\n    }\n    throw error;\n  }\n}\n"],"mappings":"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"}