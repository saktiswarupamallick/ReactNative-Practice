{"version":3,"file":"utils.js","names":["_config","data","require","_assert","_interopRequireDefault","_chalk","_crypto","_xdl","_CommandError","_interopRequireWildcard","_log","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","SECRET_MIN_LENGTH","SECRET_MAX_LENGTH","validateSecret","secret","assert","length","generateSecret","randomSecret","crypto","randomBytes","toString","Log","log","chalk","underline","setupAsync","projectRoot","_exp$owner","exp","getConfig","skipSDKVersionRequirement","slug","CommandError","ErrorCodes","MISSING_SLUG","findConfigFile","configName","user","UserManager","ensureLoggedInAsync","client","ApiV2","clientForUser","experienceName","owner","username","projects","getAsync","projectNotFoundError","project","error","code","PROJECT_NOT_FOUND"],"sources":["../../../src/commands/webhooks/utils.ts"],"sourcesContent":["import { findConfigFile, getConfig } from '@expo/config';\nimport assert from 'assert';\nimport chalk from 'chalk';\nimport crypto from 'crypto';\nimport { ApiV2, UserManager } from 'xdl';\n\nimport CommandError, { ErrorCodes } from '../../CommandError';\nimport Log from '../../log';\n\nconst SECRET_MIN_LENGTH = 16;\nconst SECRET_MAX_LENGTH = 1000;\n\nexport type WebhookEvent = 'build';\n\nexport function validateSecret({ secret }: { secret?: string }): string | null {\n  if (secret) {\n    assert(\n      secret.length >= SECRET_MIN_LENGTH && secret.length < SECRET_MAX_LENGTH,\n      `--secret: should be ${SECRET_MIN_LENGTH}-${SECRET_MAX_LENGTH} characters long`\n    );\n    return secret;\n  }\n  return null;\n}\n\nexport function generateSecret() {\n  // Create a 60 characters long secret from 30 random bytes.\n  const randomSecret = crypto.randomBytes(30).toString('hex');\n  Log.log(chalk.underline('Webhook signing secret:'));\n  Log.log(randomSecret);\n  return randomSecret;\n}\n\nexport async function setupAsync(projectRoot: string) {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  const { slug } = exp;\n  if (!slug) {\n    throw new CommandError(\n      ErrorCodes.MISSING_SLUG,\n      `expo.slug is not defined in ${findConfigFile(projectRoot).configName}`\n    );\n  }\n  const user = await UserManager.ensureLoggedInAsync();\n  const client = ApiV2.clientForUser(user);\n  const experienceName = `@${exp.owner ?? user.username}/${exp.slug}`;\n  try {\n    const projects = await client.getAsync('projects', {\n      experienceName,\n    });\n    if (projects.length === 0) {\n      throw projectNotFoundError(experienceName);\n    }\n    const project = projects[0];\n    return { experienceName, project, client };\n  } catch (error: any) {\n    if (error.code === 'EXPERIENCE_NOT_FOUND') {\n      throw projectNotFoundError(experienceName);\n    } else {\n      throw error;\n    }\n  }\n}\n\nfunction projectNotFoundError(experienceName: string) {\n  return new CommandError(\n    ErrorCodes.PROJECT_NOT_FOUND,\n    `Project ${experienceName} not found. The project is created the first time you run \\`expo publish\\` or build the project (https://docs.expo.dev/distribution/building-standalone-apps/).`\n  );\n}\n"],"mappings":"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"}