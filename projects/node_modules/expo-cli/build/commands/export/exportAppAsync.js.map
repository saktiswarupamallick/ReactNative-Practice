{"version":3,"file":"exportAppAsync.js","names":["_config","data","require","_fsExtra","_interopRequireDefault","_hashids","_path","_semver","_uuid","_xdl","_log","_writeContents","obj","__esModule","default","ANONYMOUS_USERNAME","exports","exportAppAsync","projectRoot","publicUrl","assetUrl","outputDir","options","experimentalBundle","_options$publishOptio","_options$publishOptio2","exp","pkg","hooks","Project","getPublishExpConfigAsync","publishOptions","absoluteOutputDir","path","resolve","defaultTarget","getDefaultTarget","target","assetPathToWrite","bundlesPathToWrite","Promise","all","fs","ensureDir","Log","isDebug","newLine","log","bundles","createBundlesAsync","platforms","dev","isDev","useDevServer","Env","shouldUseDevServer","printBundleSizes","hashes","fileNames","writeBundlesAsync","assets","ProjectAssets","exportAssetsAsync","hostedUrl","assetPath","dumpAssetmap","writeAssetMapAsync","dumpSourcemap","removeOriginalSourceMappingUrl","sdkVersion","semver","lt","writeSourceMapsAsync","writeDebugHtmlAsync","writeMetadataJsonAsync","validPostExportHooks","prepareHooks","mutateExpoConfigWithManifestValues","username","UserManager","getCurrentUsernameAsync","manifests","writePlatformManifestsAsync","bundleInfo","createMultiPlatformBundleInfo","runHooks","info","EmbeddedAssets","configureAsync","hookOptions","url","hook","file","runHook","e","warn","stack","assetUrlOverride","publishedTime","Date","toISOString","commitTime","releaseId","uuidv4","hashIds","HashIds","uuidv1","revisionId","encode","now","developer","tool","id","slug"],"sources":["../../../src/commands/export/exportAppAsync.ts"],"sourcesContent":["import { ExpoAppManifest, getDefaultTarget, HookArguments } from '@expo/config';\nimport fs from 'fs-extra';\nimport HashIds from 'hashids';\nimport path from 'path';\nimport semver from 'semver';\nimport { v1 as uuidv1, v4 as uuidv4 } from 'uuid';\nimport { EmbeddedAssets, Env, printBundleSizes, Project, ProjectAssets, UserManager } from 'xdl';\n\nimport Log from '../../log';\nimport { BundlePlatform } from './createMetadataJson';\nimport {\n  createMultiPlatformBundleInfo,\n  MultiPlatformBundleInfo,\n  writeAssetMapAsync,\n  writeBundlesAsync,\n  writeDebugHtmlAsync,\n  writeMetadataJsonAsync,\n  writePlatformManifestsAsync,\n  writeSourceMapsAsync,\n} from './writeContents';\n\nexport const ANONYMOUS_USERNAME = 'anonymous';\n\n/**\n * If the `experimentalBundle` flag is true, the structure of the outputDir will be:\n *\n * ```\n * ├── assets\n * │   └── *\n * ├── bundles\n * │   ├── android-01ee6e3ab3e8c16a4d926c91808d5320.js\n * │   └── ios-ee8206cc754d3f7aa9123b7f909d94ea.js\n * └── metadata.json\n * ```\n *\n * If the `experimentalBundle` flag is not true, then this function is for self hosting\n * and the outputDir will have the files created in the project directory the following way:\n *\n * ```\n * ├── android-index.json\n * ├── ios-index.json\n * ├── assets\n * │   └── 1eccbc4c41d49fd81840aef3eaabe862\n * └── bundles\n *       ├── android-01ee6e3ab3e8c16a4d926c91808d5320.js\n *       └── ios-ee8206cc754d3f7aa9123b7f909d94ea.js\n * ```\n */\nexport async function exportAppAsync(\n  projectRoot: string,\n  publicUrl: string,\n  assetUrl: string,\n  outputDir: string,\n  options: {\n    platforms: BundlePlatform[];\n    isDev?: boolean;\n    dumpAssetmap?: boolean;\n    dumpSourcemap?: boolean;\n    publishOptions?: Project.PublishOptions;\n  },\n  experimentalBundle: boolean\n): Promise<void> {\n  const { exp, pkg, hooks } = await Project.getPublishExpConfigAsync(\n    projectRoot,\n    options.publishOptions\n  );\n\n  const absoluteOutputDir = path.resolve(projectRoot, outputDir);\n  const defaultTarget = getDefaultTarget(projectRoot, exp);\n  const target = options.publishOptions?.target ?? defaultTarget;\n\n  const assetPathToWrite = path.resolve(absoluteOutputDir, 'assets');\n  const bundlesPathToWrite = path.resolve(absoluteOutputDir, 'bundles');\n\n  await Promise.all([fs.ensureDir(assetPathToWrite), fs.ensureDir(bundlesPathToWrite)]);\n\n  if (Log.isDebug) {\n    Log.newLine();\n    Log.log('Export Assets:');\n    Log.log(`- Asset target: ${target}`);\n    Log.newLine();\n  }\n\n  // Run metro bundler and create the JS bundles/source maps.\n  const bundles = await Project.createBundlesAsync(projectRoot, options.publishOptions, {\n    platforms: options.platforms,\n    dev: options.isDev,\n    useDevServer: Env.shouldUseDevServer(exp),\n    // TODO: Disable source map generation if we aren't outputting them.\n  });\n\n  // Log bundle size info to the user\n  printBundleSizes(bundles);\n\n  // Write the JS bundles to disk, and get the bundle file names (this could change with async chunk loading support).\n  const { hashes, fileNames } = await writeBundlesAsync({ bundles, outputDir: bundlesPathToWrite });\n\n  Log.log('Finished saving JS Bundles');\n\n  const { assets } = await ProjectAssets.exportAssetsAsync({\n    projectRoot,\n    exp,\n    hostedUrl: publicUrl,\n    assetPath: 'assets',\n    outputDir: absoluteOutputDir,\n    bundles,\n    experimentalBundle,\n  });\n\n  if (options.dumpAssetmap) {\n    Log.log('Dumping asset map');\n    await writeAssetMapAsync({ outputDir: absoluteOutputDir, assets });\n  }\n\n  // build source maps\n  if (options.dumpSourcemap) {\n    // TODO: Maybe move this into the bundler settings.\n    const removeOriginalSourceMappingUrl =\n      target === 'managed' && !!exp.sdkVersion && semver.lt(exp.sdkVersion, '40.0.0');\n\n    await writeSourceMapsAsync({\n      bundles,\n      hashes,\n      outputDir: bundlesPathToWrite,\n      fileNames,\n      removeOriginalSourceMappingUrl,\n    });\n    // If we output source maps, then add a debug HTML file which the user can open in\n    // the web browser to inspect the output like web.\n    await writeDebugHtmlAsync({\n      outputDir: absoluteOutputDir,\n      fileNames,\n    });\n  }\n\n  // Skip the hooks and manifest creation if building for EAS.\n  if (experimentalBundle) {\n    // Generate a metadata.json and bail.\n    await writeMetadataJsonAsync({ outputDir, bundles, fileNames });\n    return;\n  }\n\n  // Load the \"post export\" hooks\n  const validPostExportHooks = Project.prepareHooks(hooks, 'postExport', projectRoot);\n\n  // Append server values to the Expo config.\n  mutateExpoConfigWithManifestValues(exp, {\n    assetUrl,\n    isDev: options.isDev,\n    username: await UserManager.getCurrentUsernameAsync(),\n  });\n\n  // TODO: Add a comment explaining what platform manifests are used for\n  const manifests = await writePlatformManifestsAsync({\n    outputDir: absoluteOutputDir,\n    publicUrl,\n    fileNames,\n    exp,\n    pkg,\n  });\n\n  // Create the shared bundle info object in somewhat of a legacy format.\n  const bundleInfo = createMultiPlatformBundleInfo({ bundles, manifests, publicUrl });\n\n  // Run post export hooks for users who want to do things like uploading source maps to sentry.\n  runHooks({ projectRoot, exp, hooks: validPostExportHooks, info: bundleInfo });\n\n  // configure embedded assets for expo-updates or ExpoKit\n  await EmbeddedAssets.configureAsync({\n    ...bundleInfo,\n    projectRoot,\n    exp,\n    pkg,\n    target,\n  });\n}\n\nfunction runHooks({\n  projectRoot,\n  exp,\n  hooks,\n  info,\n}: {\n  projectRoot: string;\n  exp: ExpoAppManifest;\n  info: MultiPlatformBundleInfo;\n  hooks: Project.LoadedHook[];\n}) {\n  const hookOptions: Omit<HookArguments, 'config'> = {\n    url: null,\n    ...info,\n    projectRoot,\n    exp,\n    log: Log.info,\n  };\n\n  for (const hook of hooks) {\n    Log.log(`Running postExport hook: ${hook.file}`);\n    try {\n      Project.runHook(hook, hookOptions);\n    } catch (e: any) {\n      Log.warn(`Warning: postExport hook '${hook.file}' failed: ${e.stack}`);\n    }\n  }\n}\n\n// TODO: Move to expo/config for public manifests\nfunction mutateExpoConfigWithManifestValues(\n  exp: ExpoAppManifest,\n  { assetUrl, isDev, username }: { assetUrl: string; isDev?: boolean; username?: string | null }\n) {\n  // Add assetUrl to manifest\n  exp.assetUrlOverride = assetUrl;\n\n  exp.publishedTime = new Date().toISOString();\n  exp.commitTime = new Date().toISOString();\n  exp.releaseId = uuidv4();\n\n  // generate revisionId and id the same way www does\n  const hashIds = new HashIds(uuidv1(), 10);\n  exp.revisionId = hashIds.encode(Date.now());\n\n  if (isDev) {\n    exp.developer = {\n      tool: 'exp',\n    };\n  }\n\n  if (!username) {\n    username = ANONYMOUS_USERNAME;\n  }\n\n  exp.id = `@${username}/${exp.slug}`;\n\n  return exp;\n}\n"],"mappings":"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"}