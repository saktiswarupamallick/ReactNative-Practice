{"version":3,"file":"writeContents.js","names":["_crypto","data","_interopRequireDefault","require","_fs","_fsExtra","_path","_urlJoin","_log","_truncateLastLinesAsync","_createMetadataJson","obj","__esModule","default","writeAsync","folder","fileName","contents","ensureDir","fs","promises","writeFile","path","join","writeDebugHtmlAsync","outputDir","fileNames","Log","log","debugHtml","Object","values","map","createBundleFileName","platform","hash","createBundleHash","bundle","crypto","createHash","update","digest","writeBundlesAsync","bundles","hashes","bundleOutput","entries","_bundleOutput$hermesB","hermesBytecodeBundle","code","writeSourceMapsAsync","removeOriginalSourceMappingUrl","Promise","all","_bundle$hermesSourcem","_hashes$platform","_bundle$hermesBytecod","_fileNames$platform","sourceMap","hermesSourcemap","mapName","jsBundleFileName","jsPath","truncateLastLinesAsync","mappingComment","appendFile","comment","writeMetadataJsonAsync","metadata","createMetadataJson","JSON","stringify","writeAssetMapAsync","assets","fromEntries","asset","writePlatformManifestsAsync","publicUrl","exp","pkg","_pkg$dependencies","dependencies","keys","manifests","manifest","bundleUrl","urljoin","createMultiPlatformBundleInfo","key","on","_manifests$platform","_bundles$platform$her","_bundles$platform$her2","reduce","prev","cur","configKey"],"sources":["../../../src/commands/export/writeContents.ts"],"sourcesContent":["import type { ExpoAppManifest, HookArguments, PackageJSONConfig } from '@expo/config';\nimport type { BundleOutput } from '@expo/dev-server';\nimport crypto from 'crypto';\nimport fs from 'fs';\nimport { ensureDir } from 'fs-extra';\nimport path from 'path';\nimport urljoin from 'url-join';\nimport { ProjectAssets } from 'xdl';\n\nimport Log from '../../log';\nimport { truncateLastLinesAsync } from '../utils/truncateLastLinesAsync';\nimport { createMetadataJson } from './createMetadataJson';\n\ntype PlatformExpoAppManifest = ExpoAppManifest & {\n  platform: string;\n  bundleUrl: string;\n  dependencies: string[];\n};\n\nasync function writeAsync(folder: string, fileName: string, contents: any) {\n  await ensureDir(folder);\n  await fs.promises.writeFile(path.join(folder, fileName), contents);\n}\n\nexport async function writeDebugHtmlAsync({\n  outputDir,\n  fileNames,\n}: {\n  outputDir: string;\n  fileNames: Record<string, string>;\n}) {\n  // Make a debug html so user can debug their bundles\n  Log.log('Preparing additional debugging files');\n  const debugHtml = `\n      ${Object.values(fileNames)\n        .map(fileName => `<script src=\"${path.join('bundles', fileName)}\"></script>`)\n        .join('\\n      ')}\n      Open up this file in Chrome. In the JavaScript developer console, navigate to the Source tab.\n      You can see a red colored folder containing the original source code from your bundle.\n      `;\n\n  await writeAsync(outputDir, 'debug.html', debugHtml);\n}\n\n/**\n * @param props.platform native platform for the bundle\n * @param props.hash crypto hash for the bundle contents\n * @returns filename for the JS bundle.\n */\nfunction createBundleFileName({ platform, hash }: { platform: string; hash: string }): string {\n  return `${platform}-${hash}.js`;\n}\n\n/**\n * @param bundle JS bundle as a string\n * @returns crypto hash for the provided bundle\n */\nfunction createBundleHash(bundle: string | Uint8Array): string {\n  return crypto.createHash('md5').update(bundle).digest('hex');\n}\n\nexport async function writeBundlesAsync({\n  bundles,\n  outputDir,\n}: {\n  bundles: Record<string, Pick<BundleOutput, 'hermesBytecodeBundle' | 'code'>>;\n  outputDir: string;\n}) {\n  const hashes: Record<string, string> = {};\n  const fileNames: Record<string, string> = {};\n\n  for (const [platform, bundleOutput] of Object.entries(bundles)) {\n    const bundle = bundleOutput.hermesBytecodeBundle ?? bundleOutput.code;\n    const hash = createBundleHash(bundle);\n    const fileName = createBundleFileName({ platform, hash });\n\n    hashes[platform] = hash;\n    fileNames[platform] = fileName;\n    await writeAsync(outputDir, fileName, bundle);\n  }\n\n  return { hashes, fileNames };\n}\n\nexport async function writeSourceMapsAsync({\n  bundles,\n  hashes,\n  fileNames,\n  outputDir,\n  removeOriginalSourceMappingUrl,\n}: {\n  bundles: Record<\n    string,\n    Pick<BundleOutput, 'hermesSourcemap' | 'map' | 'hermesBytecodeBundle' | 'code'>\n  >;\n  hashes?: Record<string, string>;\n  fileNames?: Record<string, string>;\n  outputDir: string;\n  removeOriginalSourceMappingUrl?: boolean;\n}) {\n  return await Promise.all(\n    Object.entries(bundles).map(async ([platform, bundle]) => {\n      const sourceMap = bundle.hermesSourcemap ?? bundle.map;\n      const hash =\n        hashes?.[platform] ?? createBundleHash(bundle.hermesBytecodeBundle ?? bundle.code);\n      const mapName = `${platform}-${hash}.map`;\n      await writeAsync(outputDir, mapName, sourceMap);\n\n      const jsBundleFileName = fileNames?.[platform] ?? createBundleFileName({ platform, hash });\n      const jsPath = path.join(outputDir, jsBundleFileName);\n\n      if (removeOriginalSourceMappingUrl) {\n        // Remove original mapping to incorrect sourcemap paths\n        // In SDK 40+ and bare projects, we no longer need to do this.\n        Log.log(`Configuring source maps for ${platform}`);\n        await truncateLastLinesAsync(jsPath, 1);\n      }\n\n      // Add correct mapping to sourcemap paths\n      const mappingComment = `\\n//# sourceMappingURL=${mapName}`;\n      await fs.promises.appendFile(jsPath, mappingComment);\n      return {\n        platform,\n        fileName: mapName,\n        hash,\n        map: sourceMap,\n        comment: mappingComment,\n      };\n    })\n  );\n}\n\nexport async function writeMetadataJsonAsync({\n  outputDir,\n  bundles,\n  fileNames,\n}: {\n  outputDir: string;\n  bundles: Record<string, Pick<BundleOutput, 'assets'>>;\n  fileNames: Record<string, string>;\n}) {\n  const metadata = createMetadataJson({\n    bundles,\n    fileNames,\n  });\n  await writeAsync(outputDir, 'metadata.json', JSON.stringify(metadata));\n}\n\nexport async function writeAssetMapAsync({\n  outputDir,\n  assets,\n}: {\n  outputDir: string;\n  assets: ProjectAssets.Asset[];\n}) {\n  // Convert the assets array to a k/v pair where the asset hash is the key and the asset is the value.\n  const contents = Object.fromEntries(assets.map(asset => [asset.hash, asset]));\n\n  await writeAsync(outputDir, 'assetmap.json', JSON.stringify(contents));\n\n  return contents;\n}\n\nexport async function writePlatformManifestsAsync({\n  outputDir,\n  publicUrl,\n  fileNames,\n  exp,\n  pkg,\n}: {\n  outputDir: string;\n  publicUrl: string;\n  fileNames: Record<string, string>;\n  exp: ExpoAppManifest;\n  pkg: Pick<PackageJSONConfig, 'dependencies'>;\n}): Promise<Record<string, PlatformExpoAppManifest>> {\n  const dependencies = Object.keys(pkg.dependencies ?? {});\n  const manifests: Record<string, PlatformExpoAppManifest> = {};\n  for (const platform of Object.keys(fileNames)) {\n    // save the platform manifest\n    const manifest: PlatformExpoAppManifest = {\n      ...exp,\n      platform,\n      bundleUrl: urljoin(publicUrl, 'bundles', fileNames[platform]),\n      dependencies,\n    };\n    manifests[platform] = manifest;\n    await writeAsync(outputDir, `${platform}-index.json`, JSON.stringify(manifest));\n  }\n  return manifests;\n}\n\n// TODO: Refactor this to support more/less platforms better.\nexport type MultiPlatformBundleInfo = Pick<\n  HookArguments,\n  | 'androidManifestUrl'\n  | 'androidBundle'\n  | 'androidManifest'\n  | 'androidSourceMap'\n  | 'iosManifestUrl'\n  | 'iosBundle'\n  | 'iosManifest'\n  | 'iosSourceMap'\n>;\n\nexport function createMultiPlatformBundleInfo({\n  publicUrl,\n  bundles,\n  manifests,\n}: {\n  publicUrl: string;\n  bundles: Record<\n    string,\n    Pick<BundleOutput, 'hermesBytecodeBundle' | 'code' | 'hermesSourcemap' | 'map'>\n  >;\n  manifests: Record<string, PlatformExpoAppManifest>;\n}): MultiPlatformBundleInfo {\n  const keys: { key: string; on: (platform: string) => any }[] = [\n    {\n      key: 'ManifestUrl',\n      on: (platform: string) => urljoin(publicUrl, `${platform}-index.json`),\n    },\n    {\n      key: 'Manifest',\n      on: platform => manifests[platform] ?? null,\n    },\n    {\n      key: 'Bundle',\n      on: platform => bundles[platform].hermesBytecodeBundle ?? bundles[platform].code,\n    },\n    {\n      key: 'SourceMap',\n      on: platform => bundles[platform].hermesSourcemap ?? bundles[platform].map,\n    },\n  ];\n\n  return keys.reduce((prev, cur) => {\n    for (const platform of Object.keys(bundles)) {\n      // Like `iosManifestUrl`, or `androidBundle`\n      const configKey = platform + cur.key;\n      // @ts-ignore: needs refactor in the future -- currently a refactor would break the public API for publish hooks.\n      prev[configKey] = cur.on(platform);\n    }\n    return prev;\n  }, {} as MultiPlatformBundleInfo);\n}\n"],"mappings":"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"}