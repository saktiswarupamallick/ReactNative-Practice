{"version":3,"file":"installOnDeviceAsync.js","names":["_chalk","data","_interopRequireDefault","require","_commander","_fsExtra","_os","_path","_xdl","_CommandError","_ora","IOSDeploy","_interopRequireWildcard","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","getAppDeltaDirectory","bundleId","deltaFolder","path","join","os","tmpdir","fs","ensureDirSync","installOnDeviceAsync","props","AppleDevice","isEnabled","bundle","bundleIdentifier","appDeltaDirectory","udid","deviceName","indicator","runOnDevice","appPath","waitForApp","deltaPath","onProgress","status","isComplete","progress","ora","start","text","chalk","bold","succeed","err","fail","code","_path$basename$split$","appName","basename","split","program","nonInteractive","Prompts","confirmAsync","message","initial","CommandError"],"sources":["../../../../src/commands/run/ios/installOnDeviceAsync.ts"],"sourcesContent":["import chalk from 'chalk';\nimport program from 'commander';\nimport fs from 'fs-extra';\nimport { Ora } from 'ora';\nimport os from 'os';\nimport path from 'path';\nimport { AppleDevice, Prompts } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport { ora } from '../../../utils/ora';\nimport * as IOSDeploy from './IOSDeploy';\n\n/**\n * Get the app_delta folder for faster subsequent rebuilds on devices.\n *\n * @param bundleId\n * @returns\n */\nexport function getAppDeltaDirectory(bundleId: string): string {\n  // TODO: Maybe use .expo folder instead for debugging\n  // TODO: Reuse existing folder from xcode?\n  const deltaFolder = path.join(os.tmpdir(), 'ios', 'app-delta', bundleId);\n  fs.ensureDirSync(deltaFolder);\n  return deltaFolder;\n}\n\n// To debug: `export DEBUG=expo:xdl:*`\nexport async function installOnDeviceAsync(props: {\n  bundle: string;\n  bundleIdentifier: string;\n  appDeltaDirectory: string;\n  udid: string;\n  deviceName: string;\n}): Promise<void> {\n  if (!AppleDevice.isEnabled()) {\n    return await IOSDeploy.installOnDeviceAsync(props);\n  }\n\n  const { bundle, bundleIdentifier, appDeltaDirectory, udid, deviceName } = props;\n  let indicator: Ora | undefined;\n\n  try {\n    // TODO: Connect for logs\n    await AppleDevice.runOnDevice({\n      udid,\n      appPath: bundle,\n      bundleId: bundleIdentifier,\n      waitForApp: false,\n      deltaPath: appDeltaDirectory,\n      onProgress({\n        status,\n        isComplete,\n        progress,\n      }: {\n        status: string;\n        isComplete: boolean;\n        progress: number;\n      }) {\n        if (!indicator) {\n          indicator = ora(status).start();\n        }\n        indicator.text = `${chalk.bold(status)} ${progress}%`;\n        if (isComplete) {\n          indicator.succeed();\n        }\n      },\n    });\n  } catch (err: any) {\n    if (indicator) {\n      indicator.fail();\n    }\n    if (err.code === 'DeviceLocked') {\n      // Get the app name from the binary path.\n      const appName = path.basename(bundle).split('.')[0] ?? 'app';\n      if (\n        !program.nonInteractive &&\n        (await Prompts.confirmAsync({\n          message: `Cannot launch ${appName} because the device is locked. Unlock ${deviceName} to continue...`,\n          initial: true,\n        }))\n      ) {\n        return installOnDeviceAsync(props);\n      }\n      throw new CommandError(\n        `Cannot launch ${appName} on ${deviceName} because the device is locked.`\n      );\n    }\n    throw err;\n  }\n}\n"],"mappings":"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"}