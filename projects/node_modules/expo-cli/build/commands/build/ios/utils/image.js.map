{"version":3,"file":"image.js","names":["_axios","data","_interopRequireDefault","require","_fsExtra","_pngjs","_xdl","obj","__esModule","default","getImageStreamAsync","imagePathOrURL","isUrl","UrlUtils","isURL","protocols","requireProtocol","response","axios","get","responseType","fs","createReadStream","ensurePNGIsNotTransparent","hasAlreadyResolved","stream","Promise","res","rej","pipe","PNG","filterType","on","alpha","close","validateAlphaChannelIsEmpty","width","height","err","y","x","idx","XDLError"],"sources":["../../../../../src/commands/build/ios/utils/image.ts"],"sourcesContent":["import axios from 'axios';\nimport fs from 'fs-extra';\nimport { PNG } from 'pngjs';\nimport { Readable } from 'stream';\nimport { UrlUtils, XDLError } from 'xdl';\n\nasync function getImageStreamAsync(imagePathOrURL: string) {\n  const isUrl = UrlUtils.isURL(imagePathOrURL, {\n    protocols: ['http', 'https'],\n    requireProtocol: true,\n  });\n\n  if (isUrl) {\n    const response = await axios.get<Readable>(imagePathOrURL, { responseType: 'stream' });\n    return response.data;\n  } else {\n    return fs.createReadStream(imagePathOrURL);\n  }\n}\n\nexport async function ensurePNGIsNotTransparent(imagePathOrURL: string): Promise<void> {\n  let hasAlreadyResolved = false;\n  const stream = await getImageStreamAsync(imagePathOrURL);\n\n  return new Promise((res, rej) => {\n    stream\n      .pipe(new PNG({ filterType: 4 }))\n      .on('metadata', ({ alpha }) => {\n        if (!alpha) {\n          hasAlreadyResolved = true;\n          if ('close' in stream) stream.close();\n          res();\n        }\n      })\n      .on('parsed', () => {\n        if (hasAlreadyResolved) {\n          return;\n        }\n        try {\n          // @ts-ignore: 'this' implicitly has type 'any' because it does not have a type annotation.\n          validateAlphaChannelIsEmpty(this.data, { width: this.width, height: this.height });\n          res();\n        } catch (err: any) {\n          rej(err);\n        }\n      })\n      .on('error', err => rej(err));\n  });\n}\n\nfunction validateAlphaChannelIsEmpty(\n  data: Buffer,\n  { width, height }: { width: number; height: number }\n): void {\n  for (let y = 0; y < height; y++) {\n    for (let x = 0; x < width; x++) {\n      const idx = (width * y + x) * 4;\n      if (data[idx + 3] !== 255) {\n        throw new XDLError(\n          'INVALID_ASSETS',\n          `Your app icon can't have transparency if you wish to upload your app Apple's App Store. Read more here: https://expo.fyi/remove-alpha-channel`\n        );\n      }\n    }\n  }\n}\n"],"mappings":"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"}