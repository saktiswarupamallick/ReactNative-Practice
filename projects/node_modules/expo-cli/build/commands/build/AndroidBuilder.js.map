{"version":3,"file":"AndroidBuilder.js","names":["_xdl","data","require","_credentials","_route","_AndroidKeystore","_SetupAndroidKeystore","_getOrPromptApplicationId","_BaseBuilder","_interopRequireDefault","_BuildError","_constants","utils","_interopRequireWildcard","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","ANDROID","PLATFORMS","AndroidBuilder","BaseBuilder","run","options","type","askBuildType","apk","Android","checkSplashScreenImages","projectDir","checkForBuildInProgress","collectAndValidateCredentials","publishedExpIds","publicUrl","undefined","ensureReleaseExists","checkStatusBeforeBuild","build","checkProjectConfig","checkIfSdkIsSupported","manifest","sdkVersion","getOrPromptForPackage","updateProjectConfig","platform","_this$options$parent","nonInteractive","parent","skipCredentialsCheck","ctx","Context","init","experienceName","projectOwner","slug","clearCredentials","BuildError","runCredentialsManager","RemoveKeystore","paramKeystore","getKeystoreFromParams","useKeystore","keystore","skipKeystoreValidation","SetupAndroidKeystore","allowMissingKeystore","exports"],"sources":["../../../src/commands/build/AndroidBuilder.ts"],"sourcesContent":["import { Android } from 'xdl';\n\nimport { Context } from '../../credentials';\nimport { runCredentialsManager } from '../../credentials/route';\nimport {\n  getKeystoreFromParams,\n  RemoveKeystore,\n  useKeystore,\n} from '../../credentials/views/AndroidKeystore';\nimport { SetupAndroidKeystore } from '../../credentials/views/SetupAndroidKeystore';\nimport { getOrPromptForPackage } from '../utils/getOrPromptApplicationId';\nimport BaseBuilder from './BaseBuilder';\nimport BuildError from './BuildError';\nimport { Platform, PLATFORMS } from './constants';\nimport * as utils from './utils';\n\nconst { ANDROID } = PLATFORMS;\n\nexport default class AndroidBuilder extends BaseBuilder {\n  async run(): Promise<void> {\n    // This gets run after all other validation to prevent users from having to answer this question multiple times.\n    this.options.type = await utils.askBuildType(this.options.type!, {\n      apk: 'Build a package to deploy to the store or install directly on Android devices',\n      'app-bundle': 'Build an optimized bundle for the store',\n    });\n\n    // Check SplashScreen images sizes\n    await Android.checkSplashScreenImages(this.projectDir);\n\n    // Check the status of any current builds\n    await this.checkForBuildInProgress();\n    // Check for existing credentials, collect any missing credentials, and validate them\n    await this.collectAndValidateCredentials();\n    // Publish the current experience, if necessary\n    const publishedExpIds = this.options.publicUrl ? undefined : await this.ensureReleaseExists();\n\n    if (!this.options.publicUrl) {\n      await this.checkStatusBeforeBuild();\n    }\n\n    // Initiate a build\n    await this.build(publishedExpIds);\n  }\n\n  async checkProjectConfig(): Promise<void> {\n    // Run this first because the error messages are related\n    // to ExpoKit which is harder to change than the bundle ID.\n    await super.checkProjectConfig();\n\n    await utils.checkIfSdkIsSupported(this.manifest.sdkVersion!, ANDROID);\n\n    // Check the android package name\n    await getOrPromptForPackage(this.projectDir);\n\n    this.updateProjectConfig();\n  }\n\n  platform(): Platform {\n    return ANDROID;\n  }\n\n  async collectAndValidateCredentials(): Promise<void> {\n    const nonInteractive = this.options.parent?.nonInteractive;\n    const skipCredentialsCheck = this.options.skipCredentialsCheck === true;\n\n    const ctx = new Context();\n    await ctx.init(this.projectDir, { nonInteractive });\n\n    const experienceName = `@${ctx.projectOwner}/${ctx.manifest.slug}`;\n\n    if (this.options.clearCredentials) {\n      if (nonInteractive) {\n        throw new BuildError(\n          'Clearing your Android build credentials from our build servers is a PERMANENT and IRREVERSIBLE action, it\\'s not supported when combined with the \"--non-interactive\" option'\n        );\n      }\n      await runCredentialsManager(ctx, new RemoveKeystore(experienceName));\n    }\n\n    const paramKeystore = await getKeystoreFromParams(this.options);\n    if (paramKeystore) {\n      await useKeystore(ctx, {\n        experienceName,\n        keystore: paramKeystore,\n        skipKeystoreValidation: skipCredentialsCheck,\n      });\n    } else {\n      await runCredentialsManager(\n        ctx,\n        new SetupAndroidKeystore(experienceName, {\n          nonInteractive,\n          allowMissingKeystore: true,\n          skipKeystoreValidation: skipCredentialsCheck,\n        })\n      );\n    }\n  }\n}\n"],"mappings":"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"}