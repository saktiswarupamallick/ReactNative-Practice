{"version":3,"file":"Logger.js","names":["_bunyan","data","_interopRequireDefault","require","_isEmpty","_isPlainObject","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","LogLevel","exports","Logger","constructor","bunyanGetter","extraFields","loggerObj","bunyan","createLogger","name","loggerGetter","configure","withFields","getter","trace","all","logLine","debug","info","warn","error","fatal","level","args","argsToLog","extraFieldsFromArgsExist","isPlainObject","extraFieldsFromArgs","shift","isEmpty","unshift","LoggerDetach","_default","pipeOutputToLogger","stdout","stderr","stdoutOnly","loggerLineTransformer","on","chunk","logMultiline","source","lines","split","forEach","line","lineToPrint"],"sources":["../../src/detach/Logger.ts"],"sourcesContent":["import bunyan from '@expo/bunyan';\nimport isEmpty from 'lodash/isEmpty';\nimport isPlainObject from 'lodash/isPlainObject';\nimport { Readable } from 'stream';\n\nexport enum LogLevel {\n  trace = 'trace',\n  debug = 'debug',\n  info = 'info',\n  warn = 'warn',\n  error = 'error',\n  fatal = 'fatal',\n}\n\ntype BunyanGetter = () => bunyan;\n\nexport class Logger {\n  loggerObj: bunyan;\n  loggerGetter?: BunyanGetter;\n  extraFields: any;\n\n  constructor(bunyanGetter?: BunyanGetter, extraFields?: any) {\n    this.loggerObj = bunyan.createLogger({ name: 'xdl-detach' });\n    this.loggerGetter = bunyanGetter;\n    this.extraFields = extraFields;\n  }\n\n  configure(loggerObj: bunyan) {\n    this.loggerObj = loggerObj;\n  }\n\n  withFields(extraFields: any) {\n    const getter = this.loggerGetter || (() => this.loggerObj);\n    return new Logger(getter, { ...this.extraFields, ...extraFields });\n  }\n\n  trace(...all: any[]) {\n    this.logLine(LogLevel.trace, ...all);\n  }\n  debug(...all: any[]) {\n    this.logLine(LogLevel.debug, ...all);\n  }\n  info(...all: any[]) {\n    this.logLine(LogLevel.info, ...all);\n  }\n  warn(...all: any[]) {\n    this.logLine(LogLevel.warn, ...all);\n  }\n  error(...all: any[]) {\n    this.logLine(LogLevel.error, ...all);\n  }\n  fatal(...all: any[]) {\n    this.logLine(LogLevel.fatal, ...all);\n  }\n\n  logLine(level: LogLevel, ...args: any[]) {\n    const argsToLog = [...args];\n    const extraFieldsFromArgsExist = isPlainObject(args[0]);\n    const extraFieldsFromArgs = extraFieldsFromArgsExist ? args[0] : {};\n    if (extraFieldsFromArgsExist) {\n      argsToLog.shift();\n    }\n    const extraFields = { ...extraFieldsFromArgs, ...this.extraFields };\n    if (!isEmpty(extraFields)) {\n      argsToLog.unshift(extraFields);\n    }\n\n    if (this.loggerGetter) {\n      const loggerObj = this.loggerGetter();\n      loggerObj[level](...argsToLog);\n    } else {\n      this.loggerObj[level](...argsToLog);\n    }\n  }\n}\n\nconst LoggerDetach = new Logger();\nexport default LoggerDetach;\n\nexport function pipeOutputToLogger(\n  { stdout, stderr }: { stdout?: Readable | null; stderr?: Readable | null } = {\n    stdout: null,\n    stderr: null,\n  },\n  extraFields = {},\n  {\n    stdoutOnly = false,\n    loggerLineTransformer,\n  }: { stdoutOnly?: boolean; loggerLineTransformer?: (line: any) => any } = {}\n) {\n  if (stdout) {\n    stdout.on('data', chunk =>\n      logMultiline(chunk, { ...extraFields, source: 'stdout' }, loggerLineTransformer)\n    );\n  }\n  if (stderr) {\n    const source = stdoutOnly ? 'stdout' : 'stderr';\n    stderr.on('data', chunk =>\n      logMultiline(chunk, { ...extraFields, source }, loggerLineTransformer)\n    );\n  }\n}\n\nfunction logMultiline(data: any, extraFields: any, loggerLineTransformer?: (line: any) => any) {\n  if (!data) {\n    return;\n  }\n  const lines = String(data).split('\\n');\n  lines.forEach(line => {\n    const lineToPrint = loggerLineTransformer ? loggerLineTransformer(line) : line;\n    if (lineToPrint) {\n      const args = [lineToPrint];\n      if (!isEmpty(extraFields)) {\n        args.unshift(extraFields);\n      }\n      LoggerDetach.info(...args);\n    }\n  });\n}\n"],"mappings":"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"}