{"version":3,"file":"afc.js","names":["_debug","data","_interopRequireDefault","require","_protocol","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","debug","Debug","AFC_MAGIC","exports","AFC_HEADER_SIZE","AFC_OPS","AFC_STATUS","AFC_FILE_OPEN_FLAGS","isAFCResponse","resp","operation","id","isStatusResponse","STATUS","isErrorStatusResponse","SUCCESS","AFCInternalError","Error","constructor","msg","requestId","AFCError","status","AFCProtocolClient","ProtocolClient","socket","ProtocolReaderFactory","AFCProtocolReader","AFCProtocolWriter","reader","readerFactory","create","err","requestCallbacks","on","onData","sendMessage","Promise","resolve","reject","writer","write","ProtocolReader","callback","parseHeader","magic","slice","toString","readUInt32LE","header","totalLength","headerLength","JSON","stringify","parseBody","body","length","Array","prototype","payload","dataLength","payloadLength","Buffer","alloc","from","copy","writeUInt32LE"],"sources":["../../../../../../src/apple/native-run/ios/lib/protocol/afc.ts"],"sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport Debug from 'debug';\nimport type * as net from 'net';\n\nimport type { ProtocolReaderCallback, ProtocolWriter } from './protocol';\nimport { ProtocolClient, ProtocolReader, ProtocolReaderFactory } from './protocol';\n\nconst debug = Debug('expo:xdl:ios:lib:protocol:afc');\n\nexport const AFC_MAGIC = 'CFA6LPAA';\nexport const AFC_HEADER_SIZE = 40;\n\nexport interface AFCHeader {\n  magic: typeof AFC_MAGIC;\n  totalLength: number;\n  headerLength: number;\n  requestId: number;\n  operation: AFC_OPS;\n}\n\nexport interface AFCMessage {\n  operation: AFC_OPS;\n  data?: any;\n  payload?: any;\n}\n\nexport interface AFCResponse {\n  operation: AFC_OPS;\n  id: number;\n  data: Buffer;\n}\n\nexport interface AFCStatusResponse {\n  operation: AFC_OPS.STATUS;\n  id: number;\n  data: number;\n}\n\n/**\n * AFC Operations\n */\nexport enum AFC_OPS {\n  /**\n   * Invalid\n   */\n  INVALID = 0x00000000,\n\n  /**\n   * Status\n   */\n  STATUS = 0x00000001,\n\n  /**\n   * Data\n   */\n  DATA = 0x00000002,\n\n  /**\n   * ReadDir\n   */\n  READ_DIR = 0x00000003,\n\n  /**\n   * ReadFile\n   */\n  READ_FILE = 0x00000004,\n\n  /**\n   * WriteFile\n   */\n  WRITE_FILE = 0x00000005,\n\n  /**\n   * WritePart\n   */\n  WRITE_PART = 0x00000006,\n\n  /**\n   * TruncateFile\n   */\n  TRUNCATE = 0x00000007,\n\n  /**\n   * RemovePath\n   */\n  REMOVE_PATH = 0x00000008,\n\n  /**\n   * MakeDir\n   */\n  MAKE_DIR = 0x00000009,\n\n  /**\n   * GetFileInfo\n   */\n  GET_FILE_INFO = 0x0000000a,\n\n  /**\n   * GetDeviceInfo\n   */\n  GET_DEVINFO = 0x0000000b,\n\n  /**\n   * WriteFileAtomic (tmp file+rename)\n   */\n  WRITE_FILE_ATOM = 0x0000000c,\n\n  /**\n   * FileRefOpen\n   */\n  FILE_OPEN = 0x0000000d,\n\n  /**\n   * FileRefOpenResult\n   */\n  FILE_OPEN_RES = 0x0000000e,\n\n  /**\n   * FileRefRead\n   */\n  FILE_READ = 0x0000000f,\n\n  /**\n   * FileRefWrite\n   */\n  FILE_WRITE = 0x00000010,\n\n  /**\n   * FileRefSeek\n   */\n  FILE_SEEK = 0x00000011,\n\n  /**\n   * FileRefTell\n   */\n  FILE_TELL = 0x00000012,\n\n  /**\n   * FileRefTellResult\n   */\n  FILE_TELL_RES = 0x00000013,\n\n  /**\n   * FileRefClose\n   */\n  FILE_CLOSE = 0x00000014,\n\n  /**\n   * FileRefSetFileSize (ftruncate)\n   */\n  FILE_SET_SIZE = 0x00000015,\n\n  /**\n   * GetConnectionInfo\n   */\n  GET_CON_INFO = 0x00000016,\n\n  /**\n   * SetConnectionOptions\n   */\n  SET_CON_OPTIONS = 0x00000017,\n\n  /**\n   * RenamePath\n   */\n  RENAME_PATH = 0x00000018,\n\n  /**\n   * SetFSBlockSize (0x800000)\n   */\n  SET_FS_BS = 0x00000019,\n\n  /**\n   * SetSocketBlockSize (0x800000)\n   */\n  SET_SOCKET_BS = 0x0000001a,\n\n  /**\n   * FileRefLock\n   */\n  FILE_LOCK = 0x0000001b,\n\n  /**\n   * MakeLink\n   */\n  MAKE_LINK = 0x0000001c,\n\n  /**\n   * GetFileHash\n   */\n  GET_FILE_HASH = 0x0000001d,\n\n  /**\n   * SetModTime\n   */\n  SET_FILE_MOD_TIME = 0x0000001e,\n\n  /**\n   * GetFileHashWithRange\n   */\n  GET_FILE_HASH_RANGE = 0x0000001f,\n\n  // iOS 6+\n\n  /**\n   * FileRefSetImmutableHint\n   */\n  FILE_SET_IMMUTABLE_HINT = 0x00000020,\n\n  /**\n   * GetSizeOfPathContents\n   */\n  GET_SIZE_OF_PATH_CONTENTS = 0x00000021,\n\n  /**\n   * RemovePathAndContents\n   */\n  REMOVE_PATH_AND_CONTENTS = 0x00000022,\n\n  /**\n   * DirectoryEnumeratorRefOpen\n   */\n  DIR_OPEN = 0x00000023,\n\n  /**\n   * DirectoryEnumeratorRefOpenResult\n   */\n  DIR_OPEN_RESULT = 0x00000024,\n\n  /**\n   * DirectoryEnumeratorRefRead\n   */\n  DIR_READ = 0x00000025,\n\n  /**\n   * DirectoryEnumeratorRefClose\n   */\n  DIR_CLOSE = 0x00000026,\n\n  // iOS 7+\n\n  /**\n   * FileRefReadWithOffset\n   */\n  FILE_READ_OFFSET = 0x00000027,\n\n  /**\n   * FileRefWriteWithOffset\n   */\n  FILE_WRITE_OFFSET = 0x00000028,\n}\n\n/**\n * Error Codes\n */\nexport enum AFC_STATUS {\n  SUCCESS = 0,\n  UNKNOWN_ERROR = 1,\n  OP_HEADER_INVALID = 2,\n  NO_RESOURCES = 3,\n  READ_ERROR = 4,\n  WRITE_ERROR = 5,\n  UNKNOWN_PACKET_TYPE = 6,\n  INVALID_ARG = 7,\n  OBJECT_NOT_FOUND = 8,\n  OBJECT_IS_DIR = 9,\n  PERM_DENIED = 10,\n  SERVICE_NOT_CONNECTED = 11,\n  OP_TIMEOUT = 12,\n  TOO_MUCH_DATA = 13,\n  END_OF_DATA = 14,\n  OP_NOT_SUPPORTED = 15,\n  OBJECT_EXISTS = 16,\n  OBJECT_BUSY = 17,\n  NO_SPACE_LEFT = 18,\n  OP_WOULD_BLOCK = 19,\n  IO_ERROR = 20,\n  OP_INTERRUPTED = 21,\n  OP_IN_PROGRESS = 22,\n  INTERNAL_ERROR = 23,\n  MUX_ERROR = 30,\n  NO_MEM = 31,\n  NOT_ENOUGH_DATA = 32,\n  DIR_NOT_EMPTY = 33,\n  FORCE_SIGNED_TYPE = -1,\n}\n\nexport enum AFC_FILE_OPEN_FLAGS {\n  /**\n   * r (O_RDONLY)\n   */\n  RDONLY = 0x00000001,\n\n  /**\n   * r+ (O_RDWR | O_CREAT)\n   */\n  RW = 0x00000002,\n\n  /**\n   * w (O_WRONLY | O_CREAT | O_TRUNC)\n   */\n  WRONLY = 0x00000003,\n\n  /**\n   * w+ (O_RDWR | O_CREAT  | O_TRUNC)\n   */\n  WR = 0x00000004,\n\n  /**\n   * a (O_WRONLY | O_APPEND | O_CREAT)\n   */\n  APPEND = 0x00000005,\n\n  /**\n   * a+ (O_RDWR | O_APPEND | O_CREAT)\n   */\n  RDAPPEND = 0x00000006,\n}\n\nfunction isAFCResponse(resp: any): resp is AFCResponse {\n  return AFC_OPS[resp.operation] !== undefined && resp.id !== undefined && resp.data !== undefined;\n}\n\nfunction isStatusResponse(resp: any): resp is AFCStatusResponse {\n  return isAFCResponse(resp) && resp.operation === AFC_OPS.STATUS;\n}\n\nfunction isErrorStatusResponse(resp: AFCResponse): boolean {\n  return isStatusResponse(resp) && resp.data !== AFC_STATUS.SUCCESS;\n}\n\nclass AFCInternalError extends Error {\n  constructor(msg: string, public requestId: number) {\n    super(msg);\n  }\n}\n\nexport class AFCError extends Error {\n  constructor(msg: string, public status: AFC_STATUS) {\n    super(msg);\n  }\n}\n\nexport class AFCProtocolClient extends ProtocolClient {\n  private requestId = 0;\n  private requestCallbacks: { [key: number]: ProtocolReaderCallback } = {};\n\n  constructor(socket: net.Socket) {\n    super(socket, new ProtocolReaderFactory(AFCProtocolReader), new AFCProtocolWriter());\n\n    const reader = this.readerFactory.create((resp, err) => {\n      if (err && err instanceof AFCInternalError) {\n        this.requestCallbacks[err.requestId](resp, err);\n      } else if (isErrorStatusResponse(resp)) {\n        this.requestCallbacks[resp.id](resp, new AFCError(AFC_STATUS[resp.data], resp.data));\n      } else {\n        this.requestCallbacks[resp.id](resp);\n      }\n    });\n    socket.on('data', reader.onData);\n  }\n\n  sendMessage(msg: AFCMessage): Promise<AFCResponse> {\n    return new Promise<AFCResponse>((resolve, reject) => {\n      const requestId = this.requestId++;\n      this.requestCallbacks[requestId] = async (resp: any, err?: Error) => {\n        if (err) {\n          reject(err);\n          return;\n        }\n        if (isAFCResponse(resp)) {\n          resolve(resp);\n        } else {\n          reject(new Error('Malformed AFC response'));\n        }\n      };\n      this.writer.write(this.socket, { ...msg, requestId });\n    });\n  }\n}\n\nexport class AFCProtocolReader extends ProtocolReader {\n  private header!: AFCHeader; // TODO: ! -> ?\n\n  constructor(callback: ProtocolReaderCallback) {\n    super(AFC_HEADER_SIZE, callback);\n  }\n\n  parseHeader(data: Buffer) {\n    const magic = data.slice(0, 8).toString('ascii');\n    if (magic !== AFC_MAGIC) {\n      throw new AFCInternalError(\n        `Invalid AFC packet received (magic != ${AFC_MAGIC})`,\n        data.readUInt32LE(24)\n      );\n    }\n    // technically these are uint64\n    this.header = {\n      magic,\n      totalLength: data.readUInt32LE(8),\n      headerLength: data.readUInt32LE(16),\n      requestId: data.readUInt32LE(24),\n      operation: data.readUInt32LE(32),\n    };\n\n    debug(`parse header: ${JSON.stringify(this.header)}`);\n    if (this.header.headerLength < AFC_HEADER_SIZE) {\n      throw new AFCInternalError('Invalid AFC header', this.header.requestId);\n    }\n    return this.header.totalLength - AFC_HEADER_SIZE;\n  }\n\n  parseBody(data: Buffer): AFCResponse | AFCStatusResponse {\n    const body: any = {\n      operation: this.header.operation,\n      id: this.header.requestId,\n      data,\n    };\n    if (isStatusResponse(body)) {\n      const status = data.readUInt32LE(0);\n      debug(`${AFC_OPS[this.header.operation]} response: ${AFC_STATUS[status]}`);\n      body.data = status;\n    } else if (data.length <= 8) {\n      debug(`${AFC_OPS[this.header.operation]} response: ${Array.prototype.toString.call(body)}`);\n    } else {\n      debug(`${AFC_OPS[this.header.operation]} response length: ${data.length} bytes`);\n    }\n    return body;\n  }\n}\n\nexport class AFCProtocolWriter implements ProtocolWriter {\n  write(socket: net.Socket, msg: AFCMessage & { requestId: number }) {\n    const { data, payload, operation, requestId } = msg;\n\n    const dataLength = data ? data.length : 0;\n    const payloadLength = payload ? payload.length : 0;\n\n    const header = Buffer.alloc(AFC_HEADER_SIZE);\n    const magic = Buffer.from(AFC_MAGIC);\n    magic.copy(header);\n    header.writeUInt32LE(AFC_HEADER_SIZE + dataLength + payloadLength, 8);\n    header.writeUInt32LE(AFC_HEADER_SIZE + dataLength, 16);\n    header.writeUInt32LE(requestId, 24);\n    header.writeUInt32LE(operation, 32);\n    socket.write(header);\n    socket.write(data);\n    if (data.length <= 8) {\n      debug(\n        `socket write, header: { requestId: ${requestId}, operation: ${\n          AFC_OPS[operation]\n        }}, body: ${Array.prototype.toString.call(data)}`\n      );\n    } else {\n      debug(\n        `socket write, header: { requestId: ${requestId}, operation: ${AFC_OPS[operation]}}, body: ${data.length} bytes`\n      );\n    }\n\n    debug(`socket write, bytes written ${header.length} (header), ${data.length} (body)`);\n    if (payload) {\n      socket.write(payload);\n    }\n  }\n}\n"],"mappings":"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"}