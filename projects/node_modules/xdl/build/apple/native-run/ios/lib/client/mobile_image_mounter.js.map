{"version":3,"file":"mobile_image_mounter.js","names":["_debug","data","_interopRequireDefault","require","fs","_interopRequireWildcard","_lockdown","_client","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","debug","Debug","isMIMUploadCompleteResponse","resp","Status","isMIMUploadReceiveBytesResponse","MobileImageMounterClient","ServiceClient","constructor","socket","LockdownProtocolClient","mountImage","imagePath","imageSig","protocolClient","sendMessage","Command","ImagePath","ImageSignature","ImageType","isLockdownResponse","ResponseError","uploadImage","imageSize","statSync","size","ImageSize","resolve","reject","imageStream","createReadStream","pipe","end","on","err","lookupImage","exports"],"sources":["../../../../../../src/apple/native-run/ios/lib/client/mobile_image_mounter.ts"],"sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport Debug from 'debug';\nimport * as fs from 'fs';\nimport type * as net from 'net';\n\nimport type { LockdownCommand, LockdownResponse } from '../protocol/lockdown';\nimport { isLockdownResponse, LockdownProtocolClient } from '../protocol/lockdown';\nimport { ResponseError, ServiceClient } from './client';\n\nconst debug = Debug('expo:xdl:ios:lib:client:mobile_image_mounter');\n\nexport type MIMMountResponse = LockdownResponse;\n\nexport interface MIMMessage extends LockdownCommand {\n  ImageType: string;\n}\n\nexport interface MIMLookupResponse extends LockdownResponse {\n  ImageSignature?: string;\n}\n\nexport interface MIMUploadCompleteResponse extends LockdownResponse {\n  Status: 'Complete';\n}\n\nexport interface MIMUploadReceiveBytesResponse extends LockdownResponse {\n  Status: 'ReceiveBytesAck';\n}\n\nfunction isMIMUploadCompleteResponse(resp: any): resp is MIMUploadCompleteResponse {\n  return resp.Status === 'Complete';\n}\n\nfunction isMIMUploadReceiveBytesResponse(resp: any): resp is MIMUploadReceiveBytesResponse {\n  return resp.Status === 'ReceiveBytesAck';\n}\n\nexport class MobileImageMounterClient extends ServiceClient<LockdownProtocolClient<MIMMessage>> {\n  constructor(socket: net.Socket) {\n    super(socket, new LockdownProtocolClient(socket));\n  }\n\n  async mountImage(imagePath: string, imageSig: Buffer) {\n    debug(`mountImage: ${imagePath}`);\n\n    const resp = await this.protocolClient.sendMessage({\n      Command: 'MountImage',\n      ImagePath: imagePath,\n      ImageSignature: imageSig,\n      ImageType: 'Developer',\n    });\n\n    if (!isLockdownResponse(resp) || resp.Status !== 'Complete') {\n      throw new ResponseError(`There was an error mounting ${imagePath} on device`, resp);\n    }\n  }\n\n  async uploadImage(imagePath: string, imageSig: Buffer) {\n    debug(`uploadImage: ${imagePath}`);\n\n    const imageSize = fs.statSync(imagePath).size;\n    return this.protocolClient.sendMessage(\n      {\n        Command: 'ReceiveBytes',\n        ImageSize: imageSize,\n        ImageSignature: imageSig,\n        ImageType: 'Developer',\n      },\n      (resp: any, resolve, reject) => {\n        if (isMIMUploadReceiveBytesResponse(resp)) {\n          const imageStream = fs.createReadStream(imagePath);\n          imageStream.pipe(this.protocolClient.socket, { end: false });\n          imageStream.on('error', err => reject(err));\n        } else if (isMIMUploadCompleteResponse(resp)) {\n          resolve();\n        } else {\n          reject(\n            new ResponseError(`There was an error uploading image ${imagePath} to the device`, resp)\n          );\n        }\n      }\n    );\n  }\n\n  async lookupImage() {\n    debug('lookupImage');\n\n    return this.protocolClient.sendMessage<MIMLookupResponse>({\n      Command: 'LookupImage',\n      ImageType: 'Developer',\n    });\n  }\n}\n"],"mappings":";;;;;;AAOA,SAAAA,OAAA;EAAA,MAAAC,IAAA,GAAAC,sBAAA,CAAAC,OAAA;EAAAH,MAAA,YAAAA,CAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAG,GAAA;EAAA,MAAAH,IAAA,GAAAI,uBAAA,CAAAF,OAAA;EAAAC,EAAA,YAAAA,CAAA;IAAA,OAAAH,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAIA,SAAAK,UAAA;EAAA,MAAAL,IAAA,GAAAE,OAAA;EAAAG,SAAA,YAAAA,CAAA;IAAA,OAAAL,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AACA,SAAAM,QAAA;EAAA,MAAAN,IAAA,GAAAE,OAAA;EAAAI,OAAA,YAAAA,CAAA;IAAA,OAAAN,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAAwD,SAAAO,yBAAAC,WAAA,eAAAC,OAAA,kCAAAC,iBAAA,OAAAD,OAAA,QAAAE,gBAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,WAAA,WAAAA,WAAA,GAAAG,gBAAA,GAAAD,iBAAA,KAAAF,WAAA;AAAA,SAAAJ,wBAAAQ,GAAA,EAAAJ,WAAA,SAAAA,WAAA,IAAAI,GAAA,IAAAA,GAAA,CAAAC,UAAA,WAAAD,GAAA,QAAAA,GAAA,oBAAAA,GAAA,wBAAAA,GAAA,4BAAAE,OAAA,EAAAF,GAAA,UAAAG,KAAA,GAAAR,wBAAA,CAAAC,WAAA,OAAAO,KAAA,IAAAA,KAAA,CAAAC,GAAA,CAAAJ,GAAA,YAAAG,KAAA,CAAAE,GAAA,CAAAL,GAAA,SAAAM,MAAA,WAAAC,qBAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,GAAA,IAAAX,GAAA,QAAAW,GAAA,kBAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAd,GAAA,EAAAW,GAAA,SAAAI,IAAA,GAAAR,qBAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAV,GAAA,EAAAW,GAAA,cAAAI,IAAA,KAAAA,IAAA,CAAAV,GAAA,IAAAU,IAAA,CAAAC,GAAA,KAAAR,MAAA,CAAAC,cAAA,CAAAH,MAAA,EAAAK,GAAA,EAAAI,IAAA,YAAAT,MAAA,CAAAK,GAAA,IAAAX,GAAA,CAAAW,GAAA,SAAAL,MAAA,CAAAJ,OAAA,GAAAF,GAAA,MAAAG,KAAA,IAAAA,KAAA,CAAAa,GAAA,CAAAhB,GAAA,EAAAM,MAAA,YAAAA,MAAA;AAAA,SAAAjB,uBAAAW,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAbxD;AACA;AACA;AACA;AACA;AACA;AACA;;AASA,MAAMiB,KAAK,GAAG,IAAAC,gBAAK,EAAC,8CAA8C,CAAC;AAoBnE,SAASC,2BAA2BA,CAACC,IAAS,EAAqC;EACjF,OAAOA,IAAI,CAACC,MAAM,KAAK,UAAU;AACnC;AAEA,SAASC,+BAA+BA,CAACF,IAAS,EAAyC;EACzF,OAAOA,IAAI,CAACC,MAAM,KAAK,iBAAiB;AAC1C;AAEO,MAAME,wBAAwB,SAASC,uBAAa,CAAqC;EAC9FC,WAAWA,CAACC,MAAkB,EAAE;IAC9B,KAAK,CAACA,MAAM,EAAE,KAAIC,kCAAsB,EAACD,MAAM,CAAC,CAAC;EACnD;EAEA,MAAME,UAAUA,CAACC,SAAiB,EAAEC,QAAgB,EAAE;IACpDb,KAAK,CAAE,eAAcY,SAAU,EAAC,CAAC;IAEjC,MAAMT,IAAI,GAAG,MAAM,IAAI,CAACW,cAAc,CAACC,WAAW,CAAC;MACjDC,OAAO,EAAE,YAAY;MACrBC,SAAS,EAAEL,SAAS;MACpBM,cAAc,EAAEL,QAAQ;MACxBM,SAAS,EAAE;IACb,CAAC,CAAC;IAEF,IAAI,CAAC,IAAAC,8BAAkB,EAACjB,IAAI,CAAC,IAAIA,IAAI,CAACC,MAAM,KAAK,UAAU,EAAE;MAC3D,MAAM,KAAIiB,uBAAa,EAAE,+BAA8BT,SAAU,YAAW,EAAET,IAAI,CAAC;IACrF;EACF;EAEA,MAAMmB,WAAWA,CAACV,SAAiB,EAAEC,QAAgB,EAAE;IACrDb,KAAK,CAAE,gBAAeY,SAAU,EAAC,CAAC;IAElC,MAAMW,SAAS,GAAGjD,EAAE,CAAD,CAAC,CAACkD,QAAQ,CAACZ,SAAS,CAAC,CAACa,IAAI;IAC7C,OAAO,IAAI,CAACX,cAAc,CAACC,WAAW,CACpC;MACEC,OAAO,EAAE,cAAc;MACvBU,SAAS,EAAEH,SAAS;MACpBL,cAAc,EAAEL,QAAQ;MACxBM,SAAS,EAAE;IACb,CAAC,EACD,CAAChB,IAAS,EAAEwB,OAAO,EAAEC,MAAM,KAAK;MAC9B,IAAIvB,+BAA+B,CAACF,IAAI,CAAC,EAAE;QACzC,MAAM0B,WAAW,GAAGvD,EAAE,CAAD,CAAC,CAACwD,gBAAgB,CAAClB,SAAS,CAAC;QAClDiB,WAAW,CAACE,IAAI,CAAC,IAAI,CAACjB,cAAc,CAACL,MAAM,EAAE;UAAEuB,GAAG,EAAE;QAAM,CAAC,CAAC;QAC5DH,WAAW,CAACI,EAAE,CAAC,OAAO,EAAEC,GAAG,IAAIN,MAAM,CAACM,GAAG,CAAC,CAAC;MAC7C,CAAC,MAAM,IAAIhC,2BAA2B,CAACC,IAAI,CAAC,EAAE;QAC5CwB,OAAO,CAAC,CAAC;MACX,CAAC,MAAM;QACLC,MAAM,CACJ,KAAIP,uBAAa,EAAE,sCAAqCT,SAAU,gBAAe,EAAET,IAAI,CACzF,CAAC;MACH;IACF,CACF,CAAC;EACH;EAEA,MAAMgC,WAAWA,CAAA,EAAG;IAClBnC,KAAK,CAAC,aAAa,CAAC;IAEpB,OAAO,IAAI,CAACc,cAAc,CAACC,WAAW,CAAoB;MACxDC,OAAO,EAAE,aAAa;MACtBG,SAAS,EAAE;IACb,CAAC,CAAC;EACJ;AACF;AAACiB,OAAA,CAAA9B,wBAAA,GAAAA,wBAAA"}