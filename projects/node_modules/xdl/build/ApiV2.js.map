{"version":3,"file":"ApiV2.js","names":["_axios","data","_interopRequireDefault","require","_concatStream","_merge","_querystring","_internal","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","MAX_CONTENT_LENGTH","MAX_BODY_LENGTH","_rootBaseUrl","Config","api","scheme","host","_apiBaseUrl","rootBaseUrl","port","_convertFormDataToBuffer","formData","Promise","resolve","pipe","concat","encoding","ApiV2Error","Error","constructor","message","code","exports","ApiV2Client","clientForUser","user","setClientName","name","exponentClient","options","accessToken","sessionSecret","getAsync","methodName","args","extraOptions","returnEntireResponse","_requestAsync","httpMethod","queryParameters","postAsync","body","putAsync","patchAsync","deleteAsync","uploadFormDataAsync","uploadOptions","headers","getHeaders","extraRequestOptions","url","reqOptions","method","params","paramsSerializer","QueryString","stringify","hasOwnProperty","ConnectionStatus","isOffline","timeout","merge","maxContentLength","maxBodyLength","response","result","axios","request","e","_e$response","_e$response$data","_e$response$data$erro","errors","length","responseError","error","serverStack","stack","details","metadata"],"sources":["../src/ApiV2.ts"],"sourcesContent":["import { JSONObject, JSONValue } from '@expo/json-file';\nimport axios, { AxiosRequestConfig } from 'axios';\nimport concat from 'concat-stream';\nimport FormData from 'form-data';\nimport merge from 'lodash/merge';\nimport QueryString, { ParsedUrlQueryInput } from 'querystring';\n\nimport { Config, ConnectionStatus } from './internal';\n\nconst MAX_CONTENT_LENGTH = 100 /* MB */ * 1024 * 1024;\nconst MAX_BODY_LENGTH = 100 /* MB */ * 1024 * 1024;\n\n// These aren't constants because some commands switch between staging and prod\nfunction _rootBaseUrl() {\n  return `${Config.api.scheme}://${Config.api.host}`;\n}\n\nfunction _apiBaseUrl() {\n  let rootBaseUrl = _rootBaseUrl();\n  if (Config.api.port) {\n    rootBaseUrl += ':' + Config.api.port;\n  }\n  return rootBaseUrl + '/--/api/v2';\n}\n\nasync function _convertFormDataToBuffer(formData: FormData): Promise<{ data: Buffer }> {\n  return new Promise(resolve => {\n    formData.pipe(concat({ encoding: 'buffer' }, data => resolve({ data })));\n  });\n}\n\nexport class ApiV2Error extends Error {\n  readonly name = 'ApiV2Error';\n  code: string;\n  details?: JSONValue;\n  serverStack?: string;\n  metadata?: object;\n  readonly _isApiError = true;\n\n  constructor(message: string, code: string = 'UNKNOWN') {\n    super(message);\n    this.code = code;\n  }\n}\n\ntype RequestOptions = {\n  httpMethod: 'get' | 'post' | 'put' | 'patch' | 'delete';\n  queryParameters?: QueryParameters;\n  body?: JSONObject;\n  timeout?: number;\n};\n\ntype UploadOptions = {\n  headers: any;\n  data: any;\n};\n\ntype QueryParameters = ParsedUrlQueryInput;\n\ntype APIV2ClientOptions = {\n  sessionSecret?: string;\n  accessToken?: string;\n};\n\nexport default class ApiV2Client {\n  static exponentClient: string = 'xdl';\n  sessionSecret: string | null = null;\n  accessToken: string | null = null;\n\n  static clientForUser(user?: APIV2ClientOptions | null): ApiV2Client {\n    if (user) {\n      return new ApiV2Client(user);\n    }\n\n    return new ApiV2Client();\n  }\n\n  static setClientName(name: string) {\n    ApiV2Client.exponentClient = name;\n  }\n\n  constructor(options: APIV2ClientOptions = {}) {\n    if (options.accessToken) {\n      this.accessToken = options.accessToken;\n    }\n    if (options.sessionSecret) {\n      this.sessionSecret = options.sessionSecret;\n    }\n  }\n\n  async getAsync(\n    methodName: string,\n    args: QueryParameters = {},\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'get',\n        queryParameters: args,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async postAsync(\n    methodName: string,\n    data?: JSONObject,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'post',\n        body: data,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async putAsync(\n    methodName: string,\n    data: JSONObject,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'put',\n        body: data,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async patchAsync(\n    methodName: string,\n    data: JSONObject,\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'patch',\n        body: data,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async deleteAsync(\n    methodName: string,\n    args: QueryParameters = {},\n    extraOptions?: Partial<RequestOptions>,\n    returnEntireResponse: boolean = false\n  ) {\n    return this._requestAsync(\n      methodName,\n      {\n        httpMethod: 'delete',\n        queryParameters: args,\n      },\n      extraOptions,\n      returnEntireResponse\n    );\n  }\n\n  async uploadFormDataAsync(methodName: string, formData: FormData) {\n    const options: RequestOptions = { httpMethod: 'put' };\n    const { data } = await _convertFormDataToBuffer(formData);\n    const uploadOptions: UploadOptions = {\n      headers: formData.getHeaders(),\n      data,\n    };\n    return await this._requestAsync(methodName, options, undefined, false, uploadOptions);\n  }\n\n  async _requestAsync(\n    methodName: string,\n    options: RequestOptions,\n    extraRequestOptions: Partial<RequestOptions> = {},\n    returnEntireResponse: boolean = false,\n    uploadOptions?: UploadOptions\n  ) {\n    const url = `${_apiBaseUrl()}/${methodName}`;\n    let reqOptions: AxiosRequestConfig = {\n      url,\n      method: options.httpMethod,\n      headers: {\n        'Exponent-Client': ApiV2Client.exponentClient,\n      },\n    };\n\n    // Handle auth method, prioritizing authorization tokens before session secrets\n    if (this.accessToken) {\n      reqOptions.headers['Authorization'] = `Bearer ${this.accessToken}`;\n    } else if (this.sessionSecret) {\n      reqOptions.headers['Expo-Session'] = this.sessionSecret;\n    }\n\n    // Handle qs\n    if (options.queryParameters) {\n      reqOptions.params = options.queryParameters;\n      reqOptions.paramsSerializer = QueryString.stringify;\n    }\n\n    // Handle body\n    if (options.body) {\n      reqOptions.data = options.body;\n    }\n\n    if (!extraRequestOptions.hasOwnProperty('timeout') && ConnectionStatus.isOffline()) {\n      reqOptions.timeout = 1;\n    }\n\n    reqOptions = merge({}, reqOptions, extraRequestOptions, uploadOptions, {\n      maxContentLength: MAX_CONTENT_LENGTH,\n      maxBodyLength: MAX_BODY_LENGTH,\n    });\n\n    let response;\n    let result;\n    try {\n      response = await axios.request(reqOptions);\n      result = response.data;\n    } catch (e: any) {\n      if (e?.response?.data?.errors?.length) {\n        result = e.response.data;\n      } else {\n        throw e;\n      }\n    }\n\n    if (result.errors && result.errors.length) {\n      const responseError = result.errors[0];\n      const error = new ApiV2Error(responseError.message, responseError.code);\n      error.serverStack = responseError.stack;\n      error.details = responseError.details;\n      error.metadata = responseError.metadata;\n      throw error;\n    }\n\n    return returnEntireResponse ? response : result.data;\n  }\n}\n"],"mappings":"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"}